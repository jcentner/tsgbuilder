# Telemetry Reference

TSG Builder emits anonymous usage telemetry to Azure Application Insights. This document is the authoritative reference for every event, what triggers it, and exactly what data it contains.

For user-facing disclosure and opt-out instructions, see the [README](../README.md#telemetry).

---

## How It Works

- **Module**: [`telemetry.py`](../telemetry.py) — `init_telemetry()` sets up the OpenTelemetry logging pipeline; `track_event()` emits fire-and-forget custom events.
- **Transport**: `azure-monitor-opentelemetry-exporter` batches log records and sends them to Application Insights. Events typically appear within 2–5 minutes.
- **Connection string**: Baked into release binaries at build time via `_build_config.py` (generated by [`build_exe.py`](../build_exe.py), gitignored). Falls back to `APPINSIGHTS_CONNECTION_STRING` env var. No string = telemetry silently disabled.
- **Opt-out**: Set `TSG_TELEMETRY=0` (or `false`/`no`) in `.env` or environment. When opted out, no events are emitted and no `install_id` is generated.
- **Failure handling**: Every `track_event()` call is wrapped in `try/except` that silently swallows errors. Telemetry never affects application behavior.

---

## Common Properties

Every event automatically includes:

| Property | Type | Description |
|----------|------|-------------|
| `install_id` | string | Random UUID4 generated on first launch, persisted to `.env` as `TSG_INSTALL_ID`. Not derived from any machine, user, or network identifier. Excluded when telemetry is opted out. |

Most events also include `version` (app version string from `version.py`).

---

## Events

### `app_started`

Emitted once when the Flask server starts, in `main()`.

| Field | Kind | Description |
|-------|------|-------------|
| `version` | property | App version (e.g. `"1.2.0"`) |
| `platform` | property | `linux`, `macos`, `windows`, or `wsl2` |
| `python_version` | property | Python runtime version (e.g. `"3.11.9"`) |
| `run_mode` | property | `source` or `executable` |

**Trigger**: Server startup (`web_app.py` → `main()`).

---

### `setup_completed`

Emitted when pipeline agents are successfully created through the setup wizard.

| Field | Kind | Description |
|-------|------|-------------|
| `version` | property | App version |
| `model_deployment` | property | Name of the model deployment configured (e.g. `"gpt-5.2"`) |

**Trigger**: Successful agent creation (`web_app.py` → `api_create_agent()` success path).

---

### `tsg_generated`

Emitted when the pipeline successfully produces a TSG — both for initial generation and follow-up rounds.

| Field | Kind | Description |
|-------|------|-------------|
| `version` | property | App version |
| `had_missing` | property | `"True"` if TSG contains `{{MISSING::...}}` placeholders, `"False"` otherwise |
| `missing_sections` | property | Comma-separated section names with MISSING placeholders (e.g. `"Cause,Diagnosis"`), or empty string |
| `follow_up_round` | property | `"0"` for initial generation, `"1"`, `"2"`, etc. for follow-up rounds |
| `model` | property | `MODEL_DEPLOYMENT_NAME` env var value |
| `duration_seconds` | measurement | Total pipeline wall-clock time (seconds) |
| `research_duration_s` | measurement | Research stage wall-clock time |
| `write_duration_s` | measurement | Write stage wall-clock time |
| `review_duration_s` | measurement | Review stage wall-clock time |
| `missing_count` | measurement | Number of `{{MISSING::...}}` placeholders |
| `notes_line_count` | measurement | Number of lines in the input notes |
| `image_count` | measurement | Number of images attached to the input |
| `research_input_tokens` | measurement | Total input tokens consumed by the Research stage (accumulated across multi-turn agent interactions) |
| `research_output_tokens` | measurement | Total output tokens from Research |
| `write_input_tokens` | measurement | Total input tokens consumed by the Write stage |
| `write_output_tokens` | measurement | Total output tokens from Write |
| `review_input_tokens` | measurement | Total input tokens consumed by the Review stage (includes fix-round retries) |
| `review_output_tokens` | measurement | Total output tokens from Review |
| `total_tokens` | measurement | Sum of all per-stage input + output tokens |

**Trigger**: Successful pipeline completion (`web_app.py` → `generate_pipeline_sse_events()` success path). Also emitted from `api_answer_stream()` for follow-up rounds (with `follow_up_round > 0`).

**Token accumulation note**: The Research agent uses tools (Web Search, MCP) that produce multiple `response.completed` events per stage. Token counters are summed across all events within a stage, not overwritten.

---

### `pipeline_error`

Emitted when the pipeline fails — either via an exception or a failed `PipelineResult`.

| Field | Kind | Description |
|-------|------|-------------|
| `version` | property | App version |
| `stage` | property | Which stage failed: `research`, `write`, `review`, or `unknown` |
| `error_class` | property | Classified error type: `rate_limit`, `timeout`, `auth`, `tool_error`, or `other` |
| `retry_count` | measurement | Number of retries attempted before failure |

**Trigger**: Two paths in `generate_pipeline_sse_events()`:
1. Exception during pipeline execution (caught in the thread wrapper)
2. `PipelineResult` returned with `success=False`

Error classification uses `classify_error()` from [`pipeline.py`](../pipeline.py) for structured error categorization.

---

### `pii_blocked`

Emitted when the server-side PII gate detects personally identifiable information in user input.

| Field | Kind | Description |
|-------|------|-------------|
| `version` | property | App version |
| `action` | property | Always `"blocked"` (server-side gate prevents generation) |
| `input_type` | property | `"notes"` for initial generation, `"followup"` for follow-up answers |
| `entity_count` | measurement | Number of PII entities detected |

**Trigger**: PII detected in the defense-in-depth server-side check, in two places:
- `api_generate_stream()` — PII in initial notes
- `api_answer_stream()` — PII in follow-up answers

Note: The frontend also performs a PII check before submission. This server-side gate is defense-in-depth and will only fire if the frontend check is bypassed.

---

### `tsg_copied`

Emitted when the user copies or downloads the generated TSG.

| Field | Kind | Description |
|-------|------|-------------|
| `version` | property | App version |
| `follow_up_round` | property | Which generation round produced the exported TSG (`"0"` for initial) |
| `action` | property | `"copy"` (clipboard) or `"download"` (file save) |

**Trigger**: User clicks the Copy or Download button → `copyTSG()` / `downloadTSG()` in [`main.js`](../static/js/main.js) → fire-and-forget `POST /api/telemetry/copied` → `api_telemetry_copied()` in `web_app.py`. The endpoint always returns 204 regardless of telemetry state.

---

## What Is Never Collected

- Notes, TSG content, or any user-authored text
- Error messages containing user content
- PII of any kind
- File paths, Azure resource names, endpoints, or credentials
- IP addresses or network identifiers (IP collection is disabled on the App Insights resource)

---

## Data Flow

```
telemetry.py                 Azure Monitor
┌──────────────────┐         ┌─────────────────────┐
│ track_event()    │         │ Application Insights │
│   ↓              │         │                     │
│ logging.info()   │────────▶│ customEvents table  │
│   via OTel       │  batch  │                     │
│   LoggingHandler │  export │ Query via KQL in    │
│                  │         │ Transaction Search  │
└──────────────────┘         │ or Logs blade       │
                             └─────────────────────┘
```

### Connection String Cascade

1. `_build_config.APPINSIGHTS_CONNECTION_STRING` (release binaries — injected at build time)
2. `APPINSIGHTS_CONNECTION_STRING` environment variable (dev/admin override)
3. `None` → telemetry silently disabled (source-mode default)

### Install ID Lifecycle

1. On first `track_event()` call, `_get_or_create_install_id()` checks `TSG_INSTALL_ID` in environment
2. If not found, generates `uuid4()`, writes to `.env` via `set_key()`, caches in memory
3. Subsequent calls return the cached value
4. When `TSG_TELEMETRY=0`: returns `None`, never generates or persists an ID

---

## Querying Events

Events land in the `customEvents` table in Application Insights. Example KQL queries:

```kusto
// Daily TSG generation count (last 30 days)
customEvents
| where name == "tsg_generated"
| where timestamp > ago(30d)
| summarize count() by bin(timestamp, 1d)
| render timechart

// Average pipeline duration by stage
customEvents
| where name == "tsg_generated"
| project duration = todouble(customDimensions.duration_seconds),
          research = todouble(customDimensions.research_duration_s),
          write = todouble(customDimensions.write_duration_s),
          review = todouble(customDimensions.review_duration_s)
| summarize avg(duration), avg(research), avg(write), avg(review)

// Error breakdown by stage and class
customEvents
| where name == "pipeline_error"
| summarize count() by tostring(customDimensions.stage),
                        tostring(customDimensions.error_class)

// Active installs (distinct install_ids in last 7 days)
customEvents
| where timestamp > ago(7d)
| summarize dcount(tostring(customDimensions.install_id))

// Version adoption
customEvents
| where name == "app_started"
| where timestamp > ago(30d)
| summarize count() by tostring(customDimensions.version)
```

---

## File Reference

| File | Role |
|------|------|
| [`telemetry.py`](../telemetry.py) | Core module: init, track_event, opt-out, install_id, connection string cascade |
| [`web_app.py`](../web_app.py) | All instrumentation points (6 events emitted from here) |
| [`static/js/main.js`](../static/js/main.js) | Client-side `tsg_copied` trigger (`POST /api/telemetry/copied`) |
| [`pipeline.py`](../pipeline.py) | `PipelineResult` telemetry fields, token accumulation in `process_pipeline_v2_stream()`, error metadata |
| [`build_exe.py`](../build_exe.py) | `generate_build_config()` — writes `_build_config.py` with connection string |
| [`.github/workflows/build.yml`](../.github/workflows/build.yml) | Passes `APPINSIGHTS_CONNECTION_STRING` secret to build step |
| [`tests/test_telemetry.py`](../tests/test_telemetry.py) | Core module unit tests (34 tests) |
| [`tests/test_pipeline_telemetry.py`](../tests/test_pipeline_telemetry.py) | Pipeline plumbing tests (16 tests) |
| [`tests/test_telemetry_instrumentation.py`](../tests/test_telemetry_instrumentation.py) | Instrumentation point integration tests (29 tests) |
