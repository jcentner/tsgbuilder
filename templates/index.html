<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSG Builder</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <header>
        <div class="container">
            <h1>üîß TSG Builder</h1>
            <p class="subtitle">Transform troubleshooting notes into <strong>draft</strong> Technical Support Guides ‚Äî please carefully review the output before use. LLMs may produce variable quality output; it can be worth a retrying a draft that misses the mark.</p>
        </div>
    </header>

    <div class="container">
        <div class="status-bar">
            <div class="status-indicator" id="statusIndicator"></div>
            <span id="statusText">Checking agent status...</span>
            <button class="btn btn-secondary" id="clearSessionBtn" onclick="clearSession()" disabled title="Clear current session and start fresh" style="margin-left: auto; padding: 6px 12px; font-size: 12px;">
                üóëÔ∏è Clear Session
            </button>
            <button class="btn btn-secondary" id="setupBtn" onclick="openSetup()" style="padding: 6px 12px; font-size: 12px;">
                ‚öôÔ∏è Setup
            </button>
            <button class="btn btn-secondary" id="aboutBtn" onclick="openAbout()" style="padding: 6px 12px; font-size: 12px;">
                ‚ÑπÔ∏è About
            </button>
        </div>

        <div class="main-layout">
            <!-- Input Panel -->
            <div class="card">
                <div class="card-header">
                    <h2>üìù Input Notes</h2>
                    <a class="example-link" onclick="loadExample()">Load example</a>
                </div>
                <div class="card-body">
                    <textarea 
                        id="notesInput" 
                        placeholder="Paste your raw troubleshooting notes here...

Include:
- Problem description
- Error messages
- Steps to reproduce
- Known workarounds
- Related documentation links"
                    ></textarea>
                    
                    <!-- Image Upload Section -->
                    <div class="image-upload-section">
                        <h4>üìé Attach Images (Optional) <span class="image-count" id="imageCount"></span></h4>
                        <input type="file" id="imageInput" class="image-input" accept="image/*" multiple>
                        <div class="image-drop-zone" id="imageDropZone" onclick="document.getElementById('imageInput').click()">
                            <div class="drop-icon">üñºÔ∏è</div>
                            <div class="drop-text">Drop images here or click to upload</div>
                            <div class="drop-hint">Supports PNG, JPG, GIF ‚Ä¢ Max 10 images</div>
                        </div>
                        <div class="image-previews" id="imagePreviews"></div>
                    </div>
                    
                    <div class="actions">
                        <button class="btn btn-primary" id="generateBtn" onclick="generateTSG()">
                            <span>üöÄ</span> Generate TSG
                        </button>
                        <button class="btn btn-secondary" onclick="clearInput()">
                            Clear
                        </button>
                    </div>
                </div>
            </div>

            <!-- Output Panel -->
            <div class="card">
                <div class="card-header">
                    <h2>üìÑ Generated TSG</h2>
                    <div class="output-header-actions">
                        <div class="toggle-group">
                            <button class="toggle-btn active" id="rawToggle" onclick="setPreviewMode(false)">Raw</button>
                            <button class="toggle-btn" id="previewToggle" onclick="setPreviewMode(true)">Preview</button>
                        </div>
                        <button class="btn btn-secondary copy-btn" onclick="copyTSG()" id="copyBtn" disabled>
                            üìã Copy
                        </button>
                        <button class="btn btn-secondary" onclick="downloadTSG()" id="downloadBtn" disabled>
                            üíæ Download
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="errorMessage" class="error-message hidden"></div>
                    <div id="successMessage" class="success-message hidden"></div>
                    
                    <div id="loadingIndicator" class="loading hidden">
                        <div class="loading-header">
                            <div class="spinner"></div>
                            <span id="loadingText">Generating TSG... This may take a minute.</span>
                            <button class="btn btn-cancel" id="cancelBtn" onclick="cancelRun()" title="Cancel this run">
                                ‚úï Cancel
                            </button>
                        </div>
                        <div class="activity-feed" id="activityFeed">
                            <!-- Activity items will be added here -->
                        </div>
                    </div>
                    
                    <div class="output-area" id="tsgOutput">
                        <span style="color: var(--text-secondary);">Your generated TSG will appear here...</span>
                    </div>

                    <!-- Review Warnings Banner -->
                    <div id="warningBanner" class="warning-banner hidden"></div>

                    <!-- Follow-up Questions Panel -->
                    <div id="questionsPanel" class="questions-panel hidden">
                        <h3>üìù Feedback Needed</h3>
                        <p style="font-size: 13px; margin-bottom: 12px;">
                            Please review the items below and provide any additional information or corrections:
                        </p>
                        <div id="feedbackContent"></div>
                        <textarea 
                            id="answersInput" 
                            placeholder="Enter your feedback here...

Address any missing information and review notes above. You can also suggest corrections or additions."
                        ></textarea>
                        <div class="actions">
                            <button class="btn btn-primary" id="submitAnswersBtn" onclick="submitAnswers()">
                                Submit Feedback
                            </button>
                            <button class="btn btn-secondary" id="skipBtn" onclick="skipQuestions()">
                                Skip (Use current TSG)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Setup Modal -->
    <div id="setupModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h2>‚öôÔ∏è TSG Builder Setup</h2>
                <button class="modal-close" onclick="closeSetup()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Step 1: Configuration -->
                <div class="setup-section">
                    <h3><span class="step-number">1</span> Azure Configuration</h3>
                    <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">
                        Enter your Azure AI Foundry project details. These values are saved to your .env file.
                    </p>
                    
                    <div class="form-group">
                        <label for="configEndpoint">PROJECT_ENDPOINT</label>
                        <input type="text" id="configEndpoint" placeholder="https://your-resource.services.ai.azure.com/api/projects/your-project">
                        <p class="hint">Found in Azure Portal ‚Üí AI Foundry ‚Üí Project ‚Üí Overview</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="configModel">MODEL_DEPLOYMENT_NAME</label>
                        <input type="text" id="configModel" placeholder="gpt-4.1">
                        <p class="hint">The name of your deployed model (e.g., gpt-4.1, gpt-5.2)</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="configBing">BING_CONNECTION_NAME</label>
                        <input type="text" id="configBing" placeholder="/subscriptions/.../connections/bing-connection">
                        <p class="hint">Found in AI Foundry Portal ‚Üí Management Center ‚Üí Connected Resources</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="configAgentName">AGENT_NAME (optional)</label>
                        <input type="text" id="configAgentName" placeholder="TSG-Builder">
                        <p class="hint">Custom name prefix for your pipeline agents (default: TSG-Builder)</p>
                    </div>
                    
                    <button class="btn btn-primary" onclick="saveConfig()" id="saveConfigBtn">
                        üíæ Save Configuration
                    </button>
                    <span id="configSaveStatus" style="margin-left: 12px; font-size: 13px;"></span>
                </div>

                <!-- Step 2: Validation -->
                <div class="setup-section">
                    <h3><span class="step-number">2</span> Validate Setup</h3>
                    <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">
                        Verify your configuration, Azure authentication, and project connectivity.
                    </p>
                    
                    <ul class="validation-list" id="validationList">
                        <li class="validation-item">
                            <span class="validation-icon">‚è≥</span>
                            <span class="validation-name">Not validated</span>
                            <span class="validation-message">Click "Run Validation" to check your setup</span>
                        </li>
                    </ul>
                    
                    <button class="btn btn-secondary" onclick="runValidation()" id="validateBtn">
                        üîç Run Validation
                    </button>
                </div>

                <!-- Step 3: Create Agents -->
                <div class="setup-section">
                    <h3><span class="step-number">3</span> Create Agents</h3>
                    <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">
                        Create the three pipeline agents (Researcher, Writer, Reviewer) with Azure AI Foundry.
                    </p>
                    
                    <div id="agentStatus">
                        <div id="noAgentInfo" class="validation-item warning">
                            <span class="validation-icon">‚ö†Ô∏è</span>
                            <span class="validation-name">No Agents</span>
                            <span class="validation-message">Agents not created yet. Complete configuration and validation first.</span>
                        </div>
                    </div>
                    
                    <button class="btn btn-success" onclick="createAgent()" id="createAgentBtn" disabled style="margin-top: 12px;">
                        ü§ñ Create Agents
                    </button>
                    <span id="agentCreateStatus" style="margin-left: 12px; font-size: 13px;"></span>
                </div>
            </div>
            <div class="modal-footer">
                <div class="setup-status" id="setupOverallStatus">
                    <span>‚è≥</span> <span>Checking status...</span>
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="closeSetup()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- About Modal -->
    <div id="aboutModal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2>‚ÑπÔ∏è About TSG Builder</h2>
                <button class="modal-close" onclick="closeAbout()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="aboutContent" style="font-size: 14px;">
                    <p style="text-align: center; color: var(--text-secondary);">Loading...</p>
                </div>
            </div>
            <div class="modal-footer">
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="closeAbout()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Application Scripts -->
    <script src="/static/js/main.js"></script>
    <script src="/static/js/setup.js"></script>
</body>
</html>
