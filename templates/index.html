<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSG Builder</title>
    <style>
        :root {
            --primary: #0078d4;
            --primary-dark: #106ebe;
            --success: #107c10;
            --warning: #ff8c00;
            --error: #d13438;
            --bg: #f5f5f5;
            --card-bg: #ffffff;
            --text: #323130;
            --text-secondary: #605e5c;
            --border: #e1dfdd;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: var(--primary);
            color: white;
            padding: 16px 0;
            margin-bottom: 24px;
        }

        header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        header .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .status-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: var(--card-bg);
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--text-secondary);
        }

        .status-indicator.ready {
            background: var(--success);
        }

        .status-indicator.error {
            background: var(--error);
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header h2 {
            font-size: 18px;
            font-weight: 600;
        }

        .card-body {
            padding: 20px;
        }

        textarea {
            width: 100%;
            min-height: 300px;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            resize: vertical;
            line-height: 1.6;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.2);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-primary:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--bg);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .output-area {
            min-height: 300px;
            max-height: 600px;
            overflow-y: auto;
            padding: 16px;
            background: #fafafa;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .questions-panel {
            margin-top: 20px;
            padding: 16px;
            background: #fff8e5;
            border: 1px solid var(--warning);
            border-radius: 6px;
        }

        .questions-panel h3 {
            color: var(--warning);
            margin-bottom: 12px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .questions-panel pre {
            font-family: inherit;
            white-space: pre-wrap;
            margin-bottom: 12px;
            color: var(--text);
        }

        .questions-panel textarea {
            min-height: 100px;
            margin-bottom: 12px;
        }

        .loading {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 20px;
            color: var(--text-secondary);
        }

        .loading-header {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .activity-feed {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            padding: 12px;
            background: #f8f8f8;
            border-radius: 6px;
            font-size: 13px;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: white;
            border-radius: 4px;
            border-left: 3px solid var(--border);
            animation: slideIn 0.2s ease-out;
        }

        .activity-item.status {
            border-left-color: var(--primary);
        }

        .activity-item.tool {
            border-left-color: var(--success);
        }

        .activity-item.tool.completed {
            opacity: 0.7;
        }

        .activity-item.error {
            border-left-color: var(--error);
            background: #fde7e9;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .activity-icon {
            font-size: 16px;
        }

        .activity-message {
            flex: 1;
        }

        .activity-time {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .error-message {
            padding: 12px 16px;
            background: #fde7e9;
            border: 1px solid var(--error);
            border-radius: 6px;
            color: var(--error);
            margin-bottom: 16px;
        }

        .success-message {
            padding: 12px 16px;
            background: #dff6dd;
            border: 1px solid var(--success);
            border-radius: 6px;
            color: var(--success);
            margin-bottom: 16px;
        }

        .hidden {
            display: none !important;
        }

        .example-link {
            color: var(--primary);
            cursor: pointer;
            text-decoration: underline;
            font-size: 13px;
        }

        .example-link:hover {
            color: var(--primary-dark);
        }

        .copy-btn {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* Setup Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: var(--card-bg);
            border-radius: 12px;
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 4px 8px;
        }

        .modal-close:hover {
            color: var(--text);
        }

        .modal-body {
            padding: 24px;
        }

        .setup-section {
            margin-bottom: 24px;
        }

        .setup-section h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .setup-section h3 .step-number {
            background: var(--primary);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text);
        }

        .form-group .hint {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .form-group input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 13px;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.2);
        }

        .validation-list {
            list-style: none;
            padding: 0;
        }

        .validation-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: #fafafa;
            border-radius: 6px;
            margin-bottom: 8px;
            border: 1px solid var(--border);
        }

        .validation-item.passed {
            background: #dff6dd;
            border-color: var(--success);
        }

        .validation-item.failed {
            background: #fde7e9;
            border-color: var(--error);
        }

        .validation-item.warning {
            background: #fff8e5;
            border-color: var(--warning);
        }

        .validation-icon {
            font-size: 16px;
        }

        .validation-name {
            font-weight: 600;
            min-width: 140px;
        }

        .validation-message {
            flex: 1;
            font-size: 12px;
            color: var(--text-secondary);
            word-break: break-all;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .modal-footer .btn-group {
            display: flex;
            gap: 12px;
        }

        .setup-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .setup-status.ready {
            color: var(--success);
        }

        .setup-status.pending {
            color: var(--warning);
        }

        .btn-link {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 13px;
            text-decoration: underline;
        }

        .btn-link:hover {
            color: var(--primary-dark);
        }

        .agent-info {
            padding: 16px;
            background: #dff6dd;
            border: 1px solid var(--success);
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .agent-info .icon {
            font-size: 24px;
        }

        .agent-info .details {
            flex: 1;
        }

        .agent-info .agent-name {
            font-weight: 600;
        }

        .agent-info .agent-id {
            font-size: 12px;
            color: var(--text-secondary);
            font-family: monospace;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>üîß TSG Builder</h1>
            <p class="subtitle">Transform troubleshooting notes into production-quality Technical Support Guides</p>
        </div>
    </header>

    <div class="container">
        <div class="status-bar">
            <div class="status-indicator" id="statusIndicator"></div>
            <span id="statusText">Checking agent status...</span>
            <button class="btn btn-secondary" id="setupBtn" onclick="openSetup()" style="margin-left: auto; padding: 6px 12px; font-size: 12px;">
                ‚öôÔ∏è Setup
            </button>
        </div>

        <div class="main-layout">
            <!-- Input Panel -->
            <div class="card">
                <div class="card-header">
                    <h2>üìù Input Notes</h2>
                    <a class="example-link" onclick="loadExample()">Load example</a>
                </div>
                <div class="card-body">
                    <textarea 
                        id="notesInput" 
                        placeholder="Paste your raw troubleshooting notes here...

Include:
- Problem description
- Error messages
- Steps to reproduce
- Known workarounds
- Related documentation links"
                    ></textarea>
                    <div class="actions">
                        <button class="btn btn-primary" id="generateBtn" onclick="generateTSG()">
                            <span>üöÄ</span> Generate TSG
                        </button>
                        <button class="btn btn-secondary" onclick="clearInput()">
                            Clear
                        </button>
                    </div>
                </div>
            </div>

            <!-- Output Panel -->
            <div class="card">
                <div class="card-header">
                    <h2>üìÑ Generated TSG</h2>
                    <button class="btn btn-secondary copy-btn" onclick="copyTSG()" id="copyBtn" disabled>
                        üìã Copy
                    </button>
                </div>
                <div class="card-body">
                    <div id="errorMessage" class="error-message hidden"></div>
                    <div id="successMessage" class="success-message hidden"></div>
                    
                    <div id="loadingIndicator" class="loading hidden">
                        <div class="loading-header">
                            <div class="spinner"></div>
                            <span id="loadingText">Generating TSG... This may take a minute.</span>
                        </div>
                        <div class="activity-feed" id="activityFeed">
                            <!-- Activity items will be added here -->
                        </div>
                    </div>
                    
                    <div class="output-area" id="tsgOutput">
                        <span style="color: var(--text-secondary);">Your generated TSG will appear here...</span>
                    </div>

                    <!-- Follow-up Questions Panel -->
                    <div id="questionsPanel" class="questions-panel hidden">
                        <h3>‚ö†Ô∏è Follow-up Questions</h3>
                        <p style="font-size: 13px; margin-bottom: 12px;">
                            The agent needs more information to complete the TSG. Please answer the questions below:
                        </p>
                        <pre id="questionsText"></pre>
                        <textarea 
                            id="answersInput" 
                            placeholder="Enter your answers here..."
                        ></textarea>
                        <div class="actions">
                            <button class="btn btn-primary" onclick="submitAnswers()">
                                Submit Answers
                            </button>
                            <button class="btn btn-secondary" onclick="skipQuestions()">
                                Skip (Use current TSG)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentThreadId = null;
        let currentTSG = '';
        let eventSource = null;

        // Check agent status on load
        document.addEventListener('DOMContentLoaded', checkStatus);

        async function checkStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                const indicator = document.getElementById('statusIndicator');
                const text = document.getElementById('statusText');
                const btn = document.getElementById('generateBtn');
                
                if (data.ready) {
                    indicator.className = 'status-indicator ready';
                    text.textContent = `Agent ready (${data.agent.id})`;
                    btn.disabled = false;
                } else {
                    indicator.className = 'status-indicator error';
                    text.textContent = data.error || 'Setup required';
                    btn.disabled = true;
                    
                    // Auto-open setup if needs configuration
                    if (data.needs_setup) {
                        openSetup();
                    }
                }
            } catch (error) {
                document.getElementById('statusIndicator').className = 'status-indicator error';
                document.getElementById('statusText').textContent = 'Failed to check status';
            }
        }

        function addActivity(icon, message, type = 'status') {
            const feed = document.getElementById('activityFeed');
            const item = document.createElement('div');
            item.className = `activity-item ${type}`;
            
            const time = new Date().toLocaleTimeString();
            item.innerHTML = `
                <span class="activity-icon">${icon}</span>
                <span class="activity-message">${message}</span>
                <span class="activity-time">${time}</span>
            `;
            
            feed.appendChild(item);
            feed.scrollTop = feed.scrollHeight;
        }

        function clearActivity() {
            document.getElementById('activityFeed').innerHTML = '';
        }

        function generateTSGWithStreaming(endpoint, body) {
            return new Promise((resolve, reject) => {
                clearActivity();
                addActivity('üöÄ', 'Starting agent...', 'status');
                
                // Use fetch with streaming for SSE
                fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                }).then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            throw new Error(err.error || 'Request failed');
                        });
                    }
                    
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';
                    
                    function processText(text) {
                        buffer += text;
                        const lines = buffer.split('\n');
                        buffer = lines.pop(); // Keep incomplete line in buffer
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const event = JSON.parse(line.slice(6));
                                    handleStreamEvent(event, resolve, reject);
                                } catch (e) {
                                    // Ignore parse errors for malformed events
                                }
                            }
                        }
                    }
                    
                    function read() {
                        reader.read().then(({ done, value }) => {
                            if (done) {
                                if (buffer.startsWith('data: ')) {
                                    try {
                                        const event = JSON.parse(buffer.slice(6));
                                        handleStreamEvent(event, resolve, reject);
                                    } catch (e) {}
                                }
                                return;
                            }
                            processText(decoder.decode(value, { stream: true }));
                            read();
                        }).catch(reject);
                    }
                    
                    read();
                }).catch(reject);
            });
        }

        function handleStreamEvent(event, resolve, reject) {
            switch (event.type) {
                case 'thread_created':
                    currentThreadId = event.data.thread_id;
                    break;
                    
                case 'status':
                    const statusIcons = {
                        'queued': '‚è≥',
                        'in_progress': 'üîÑ',
                        'requires_action': '‚ö°',
                        'completed': '‚úÖ',
                        'failed': '‚ùå'
                    };
                    const icon = statusIcons[event.data.status] || '‚Ä¢';
                    addActivity(icon, event.data.message, 'status');
                    document.getElementById('loadingText').textContent = event.data.message;
                    break;
                    
                case 'tool':
                    const toolClass = event.data.status === 'completed' ? 'tool completed' : 'tool';
                    addActivity(event.data.icon, event.data.message, toolClass);
                    break;
                    
                case 'activity':
                    addActivity('üìù', event.data.message, 'status');
                    break;
                    
                case 'error':
                    addActivity('‚ùå', event.data.message, 'error');
                    // Include raw_response in error for debugging
                    const errorMsg = event.data.raw_response 
                        ? `${event.data.message}\n\n--- Raw Agent Response ---\n${event.data.raw_response}`
                        : event.data.message;
                    reject(new Error(errorMsg));
                    break;
                    
                case 'result':
                    currentThreadId = event.data.thread_id;
                    currentTSG = event.data.tsg;
                    resolve(event.data);
                    break;
                    
                case 'done':
                    addActivity('‚úì', 'Agent completed', 'status');
                    break;
                    
                case 'keepalive':
                    // Ignore keepalives
                    break;
            }
        }

        async function generateTSG() {
            const notes = document.getElementById('notesInput').value.trim();
            if (!notes) {
                showError('Please enter some notes first.');
                return;
            }

            showLoading(true);
            hideMessages();
            document.getElementById('questionsPanel').classList.add('hidden');

            try {
                const data = await generateTSGWithStreaming('/api/generate/stream', { notes });
                
                displayTSG(data.tsg);

                if (data.questions && !data.complete) {
                    showQuestions(data.questions);
                } else {
                    showSuccess('TSG generated successfully!');
                }

            } catch (error) {
                showError(error.message);
            } finally {
                showLoading(false);
            }
        }

        async function submitAnswers() {
            const answers = document.getElementById('answersInput').value.trim();
            if (!answers) {
                showError('Please provide answers to the questions.');
                return;
            }

            showLoading(true);
            hideMessages();

            try {
                const data = await generateTSGWithStreaming('/api/answer/stream', {
                    thread_id: currentThreadId,
                    answers
                });

                displayTSG(data.tsg);

                if (data.questions && !data.complete) {
                    showQuestions(data.questions);
                    document.getElementById('answersInput').value = '';
                } else {
                    document.getElementById('questionsPanel').classList.add('hidden');
                    showSuccess('TSG updated and complete!');
                }

            } catch (error) {
                showError(error.message);
            } finally {
                showLoading(false);
            }
        }

        function skipQuestions() {
            document.getElementById('questionsPanel').classList.add('hidden');
            showSuccess('TSG saved with current content.');
        }

        function displayTSG(tsg) {
            document.getElementById('tsgOutput').textContent = tsg;
            document.getElementById('copyBtn').disabled = false;
        }

        function showQuestions(questions) {
            document.getElementById('questionsText').textContent = questions;
            document.getElementById('questionsPanel').classList.remove('hidden');
        }

        function showLoading(show) {
            const loading = document.getElementById('loadingIndicator');
            const btn = document.getElementById('generateBtn');
            
            if (show) {
                loading.classList.remove('hidden');
                btn.disabled = true;
            } else {
                loading.classList.add('hidden');
                btn.disabled = false;
            }
        }

        function showError(message) {
            const el = document.getElementById('errorMessage');
            
            // Check if message contains raw response (separated by ---)
            const separator = '--- Raw Agent Response ---';
            if (message.includes(separator)) {
                const [errorPart, rawPart] = message.split(separator);
                el.innerHTML = `
                    <div>${escapeHtml(errorPart.trim())}</div>
                    <details style="margin-top: 10px;">
                        <summary style="cursor: pointer; color: var(--primary);">Show raw agent response (for debugging)</summary>
                        <pre style="margin-top: 8px; padding: 10px; background: #1e1e1e; border-radius: 4px; overflow-x: auto; white-space: pre-wrap; word-break: break-word; font-size: 12px; max-height: 300px; overflow-y: auto;">${escapeHtml(rawPart.trim())}</pre>
                    </details>
                `;
            } else {
                el.textContent = message;
            }
            el.classList.remove('hidden');
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showSuccess(message) {
            const el = document.getElementById('successMessage');
            el.textContent = message;
            el.classList.remove('hidden');
        }

        function hideMessages() {
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('successMessage').classList.add('hidden');
        }

        function clearInput() {
            document.getElementById('notesInput').value = '';
            document.getElementById('tsgOutput').innerHTML = 
                '<span style="color: var(--text-secondary);">Your generated TSG will appear here...</span>';
            document.getElementById('questionsPanel').classList.add('hidden');
            document.getElementById('copyBtn').disabled = true;
            hideMessages();
            currentThreadId = null;
            currentTSG = '';
        }

        async function copyTSG() {
            if (!currentTSG) return;
            
            try {
                await navigator.clipboard.writeText(currentTSG);
                const btn = document.getElementById('copyBtn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚úì Copied!';
                setTimeout(() => { btn.innerHTML = originalText; }, 2000);
            } catch (error) {
                showError('Failed to copy to clipboard');
            }
        }

        function loadExample() {
            document.getElementById('notesInput').value = `Problem/questions:

When I try to create an Agent in my project (with the GA version in an Azure AI Foundry project, not a hub-based project), I can only use model deployments deployed in my current Azure AI Foundry resource, despite having connected Azure OpenAI resources.

1. When the OAI model is deployed on project level, the option to select a model is available when trying to create an agent from the studio. But the models deployed on the connected OpenAI resource does not show up. Is this a limitation?
2. Even if we create the agent via SDK using a model deployment from the connected OpenAI resource, there is no option to select the deployments from the OpenAI resource.

Generally: "When using an Agent in my project, why can't I use it/see it with a model deployment in a connected Azure OpenAI resource?"

Background:
https://learn.microsoft.com/en-us/azure/ai-foundry/agents/environment-setup
https://learn.microsoft.com/en-us/azure/ai-foundry/agents/concepts/capability-hosts

Limitation:
Known issue with Agents seeing connected OpenAI resource deployments in the UI. The project capability host is only configured by default with the project AI Services resource.

Workaround:
Create new capability host that points at an OpenAI resource instead of the AI Services resource using the aiServicesConnections property.`;
        }
    </script>

    <!-- Setup Modal -->
    <div id="setupModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h2>‚öôÔ∏è TSG Builder Setup</h2>
                <button class="modal-close" onclick="closeSetup()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Step 1: Configuration -->
                <div class="setup-section">
                    <h3><span class="step-number">1</span> Azure Configuration</h3>
                    <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">
                        Enter your Azure AI Foundry project details. These values are saved to your .env file.
                    </p>
                    
                    <div class="form-group">
                        <label for="configEndpoint">PROJECT_ENDPOINT</label>
                        <input type="text" id="configEndpoint" placeholder="https://your-resource.services.ai.azure.com/api/projects/your-project">
                        <p class="hint">Found in Azure Portal ‚Üí AI Foundry ‚Üí Project ‚Üí Overview</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="configModel">MODEL_DEPLOYMENT_NAME</label>
                        <input type="text" id="configModel" placeholder="gpt-4.1">
                        <p class="hint">The name of your deployed model (e.g., gpt-4.1, gpt-5.2)</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="configBing">BING_CONNECTION_NAME</label>
                        <input type="text" id="configBing" placeholder="/subscriptions/.../connections/bing-connection">
                        <p class="hint">Found in AI Foundry Portal ‚Üí Management Center ‚Üí Connected Resources</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="configAgentName">AGENT_NAME (optional)</label>
                        <input type="text" id="configAgentName" placeholder="TSG-Builder">
                        <p class="hint">Custom name for your agent (default: TSG-Builder)</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="configPromptStyle">Prompt Style</label>
                        <select id="configPromptStyle" style="width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary); font-size: 14px;">
                            <!-- Options populated dynamically -->
                        </select>
                        <p class="hint" id="promptStyleHint">Select based on your model deployment</p>
                    </div>
                    
                    <button class="btn btn-primary" onclick="saveConfig()" id="saveConfigBtn">
                        üíæ Save Configuration
                    </button>
                    <span id="configSaveStatus" style="margin-left: 12px; font-size: 13px;"></span>
                </div>

                <!-- Step 2: Validation -->
                <div class="setup-section">
                    <h3><span class="step-number">2</span> Validate Setup</h3>
                    <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">
                        Verify your configuration, Azure authentication, and project connectivity.
                    </p>
                    
                    <ul class="validation-list" id="validationList">
                        <li class="validation-item">
                            <span class="validation-icon">‚è≥</span>
                            <span class="validation-name">Not validated</span>
                            <span class="validation-message">Click "Run Validation" to check your setup</span>
                        </li>
                    </ul>
                    
                    <button class="btn btn-secondary" onclick="runValidation()" id="validateBtn">
                        üîç Run Validation
                    </button>
                </div>

                <!-- Step 3: Create Agent -->
                <div class="setup-section">
                    <h3><span class="step-number">3</span> Create Agent</h3>
                    <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">
                        Create the Azure AI Foundry agent with Bing Search and Microsoft Learn tools.
                    </p>
                    
                    <div id="agentStatus">
                        <div id="noAgentInfo" class="validation-item warning">
                            <span class="validation-icon">‚ö†Ô∏è</span>
                            <span class="validation-name">No Agent</span>
                            <span class="validation-message">Agent not created yet. Complete configuration and validation first.</span>
                        </div>
                    </div>
                    
                    <button class="btn btn-success" onclick="createAgent()" id="createAgentBtn" disabled style="margin-top: 12px;">
                        ü§ñ Create Agent
                    </button>
                    <span id="agentCreateStatus" style="margin-left: 12px; font-size: 13px;"></span>
                </div>
            </div>
            <div class="modal-footer">
                <div class="setup-status" id="setupOverallStatus">
                    <span>‚è≥</span> <span>Checking status...</span>
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="closeSetup()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Setup modal functions
        async function openSetup() {
            document.getElementById('setupModal').classList.remove('hidden');
            await loadConfig();
            updateSetupOverallStatus();
        }

        function closeSetup() {
            document.getElementById('setupModal').classList.add('hidden');
            checkStatus(); // Refresh main status
        }

        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                
                document.getElementById('configEndpoint').value = config.PROJECT_ENDPOINT || '';
                document.getElementById('configModel').value = config.MODEL_DEPLOYMENT_NAME || '';
                document.getElementById('configBing').value = config.BING_CONNECTION_NAME || '';
                document.getElementById('configAgentName').value = config.AGENT_NAME || 'TSG-Builder';
                
                // Populate prompt style dropdown
                const promptStyleSelect = document.getElementById('configPromptStyle');
                const promptStyleHint = document.getElementById('promptStyleHint');
                promptStyleSelect.innerHTML = '';
                
                if (config.prompt_styles) {
                    for (const [key, info] of Object.entries(config.prompt_styles)) {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = info.name;
                        option.title = info.description;
                        if (key === (config.PROMPT_STYLE || config.default_prompt_style)) {
                            option.selected = true;
                        }
                        promptStyleSelect.appendChild(option);
                    }
                    
                    // Update hint when selection changes
                    promptStyleSelect.addEventListener('change', () => {
                        const selected = promptStyleSelect.value;
                        const info = config.prompt_styles[selected];
                        if (info) {
                            promptStyleHint.textContent = info.description;
                        }
                    });
                    
                    // Set initial hint
                    const currentStyle = config.PROMPT_STYLE || config.default_prompt_style;
                    if (config.prompt_styles[currentStyle]) {
                        promptStyleHint.textContent = config.prompt_styles[currentStyle].description;
                    }
                }
            } catch (error) {
                console.error('Failed to load config:', error);
            }
        }

        async function saveConfig() {
            const btn = document.getElementById('saveConfigBtn');
            const status = document.getElementById('configSaveStatus');
            
            btn.disabled = true;
            status.textContent = 'Saving...';
            status.style.color = 'var(--text-secondary)';
            
            const config = {
                PROJECT_ENDPOINT: document.getElementById('configEndpoint').value.trim(),
                MODEL_DEPLOYMENT_NAME: document.getElementById('configModel').value.trim(),
                BING_CONNECTION_NAME: document.getElementById('configBing').value.trim(),
                AGENT_NAME: document.getElementById('configAgentName').value.trim() || 'TSG-Builder',
                PROMPT_STYLE: document.getElementById('configPromptStyle').value,
            };
            
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    status.textContent = '‚úì Saved!';
                    status.style.color = 'var(--success)';
                    updateSetupOverallStatus();
                } else {
                    status.textContent = '‚úó ' + (result.error || 'Failed to save');
                    status.style.color = 'var(--error)';
                }
            } catch (error) {
                status.textContent = '‚úó ' + error.message;
                status.style.color = 'var(--error)';
            } finally {
                btn.disabled = false;
                setTimeout(() => { status.textContent = ''; }, 3000);
            }
        }

        async function runValidation() {
            const btn = document.getElementById('validateBtn');
            const list = document.getElementById('validationList');
            
            btn.disabled = true;
            btn.textContent = 'üîÑ Validating...';
            list.innerHTML = '<li class="validation-item"><span class="validation-icon">üîÑ</span><span class="validation-message">Running validation checks...</span></li>';
            
            try {
                const response = await fetch('/api/validate');
                const result = await response.json();
                
                list.innerHTML = '';
                
                for (const check of result.checks) {
                    const item = document.createElement('li');
                    const statusClass = check.passed ? 'passed' : (check.critical ? 'failed' : 'warning');
                    const icon = check.passed ? '‚úì' : (check.critical ? '‚úó' : '‚ö†Ô∏è');
                    
                    item.className = `validation-item ${statusClass}`;
                    item.innerHTML = `
                        <span class="validation-icon">${icon}</span>
                        <span class="validation-name">${check.name}</span>
                        <span class="validation-message">${check.message}</span>
                    `;
                    list.appendChild(item);
                }
                
                // Enable/disable create agent button based on validation
                const createBtn = document.getElementById('createAgentBtn');
                createBtn.disabled = !result.ready_for_agent;
                
                updateSetupOverallStatus();
                
            } catch (error) {
                list.innerHTML = `<li class="validation-item failed"><span class="validation-icon">‚úó</span><span class="validation-message">Validation failed: ${error.message}</span></li>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîç Run Validation';
            }
        }

        async function createAgent() {
            const btn = document.getElementById('createAgentBtn');
            const status = document.getElementById('agentCreateStatus');
            const agentStatusDiv = document.getElementById('agentStatus');
            
            btn.disabled = true;
            btn.textContent = 'üîÑ Creating...';
            status.textContent = 'This may take a moment...';
            status.style.color = 'var(--text-secondary)';
            
            try {
                const response = await fetch('/api/create-agent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    status.textContent = '‚úì Agent created!';
                    status.style.color = 'var(--success)';
                    
                    agentStatusDiv.innerHTML = `
                        <div class="agent-info">
                            <span class="icon">ü§ñ</span>
                            <div class="details">
                                <div class="agent-name">${result.agent_name}</div>
                                <div class="agent-id">ID: ${result.agent_id}</div>
                            </div>
                        </div>
                    `;
                    
                    btn.textContent = '‚úì Agent Created';
                    updateSetupOverallStatus();
                } else {
                    status.textContent = '‚úó ' + result.error;
                    status.style.color = 'var(--error)';
                    btn.disabled = false;
                    btn.textContent = 'ü§ñ Create Agent';
                }
            } catch (error) {
                status.textContent = '‚úó ' + error.message;
                status.style.color = 'var(--error)';
                btn.disabled = false;
                btn.textContent = 'ü§ñ Create Agent';
            }
        }

        async function updateSetupOverallStatus() {
            const statusDiv = document.getElementById('setupOverallStatus');
            
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                if (data.ready) {
                    statusDiv.className = 'setup-status ready';
                    statusDiv.innerHTML = '<span>‚úì</span> <span>Ready to generate TSGs!</span>';
                } else if (data.needs_setup) {
                    statusDiv.className = 'setup-status pending';
                    statusDiv.innerHTML = '<span>‚ö†Ô∏è</span> <span>Setup incomplete</span>';
                } else {
                    statusDiv.className = 'setup-status pending';
                    statusDiv.innerHTML = '<span>‚è≥</span> <span>Checking...</span>';
                }
                
                // Update agent status display
                if (data.agent && data.agent.exists) {
                    document.getElementById('agentStatus').innerHTML = `
                        <div class="agent-info">
                            <span class="icon">ü§ñ</span>
                            <div class="details">
                                <div class="agent-name">Agent Ready</div>
                                <div class="agent-id">ID: ${data.agent.id}</div>
                            </div>
                        </div>
                    `;
                    document.getElementById('createAgentBtn').textContent = '‚úì Agent Exists';
                }
                
            } catch (error) {
                statusDiv.className = 'setup-status';
                statusDiv.innerHTML = '<span>‚ö†Ô∏è</span> <span>Status check failed</span>';
            }
        }
    </script>
</body>
</html>
